<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NexusAI Synth Pad Generator</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #0a0a1a; color: #e0e0ff; font-family: 'Segoe UI', sans-serif; padding: 20px; }
h1 { text-align: center; color: #ff6ec7; margin-bottom: 5px; font-size: 1.8em; }
.subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9em; }
.panel { background: #12122a; border: 1px solid #2a2a4a; border-radius: 10px; padding: 20px; margin-bottom: 15px; }
.panel h2 { color: #7b68ee; margin-bottom: 15px; font-size: 1.1em; }
.row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; }
.control { flex: 1; min-width: 150px; }
label { display: block; font-size: 0.8em; color: #888; margin-bottom: 4px; }
select, input[type=range], input[type=number] { width: 100%; background: #1a1a3a; border: 1px solid #333; color: #e0e0ff; padding: 6px; border-radius: 5px; }
input[type=range] { padding: 0; height: 6px; -webkit-appearance: none; appearance: none; background: #333; border-radius: 3px; cursor: pointer; }
input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #ff6ec7; border-radius: 50%; cursor: pointer; }
.val { font-size: 0.75em; color: #ff6ec7; float: right; }
.chord-seq { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
.chord-slot { background: #1a1a3a; border: 1px solid #444; border-radius: 6px; padding: 8px 4px; text-align: center; min-width: 70px; }
.chord-slot select { font-size: 0.85em; }
.chord-slot .label { font-size: 0.7em; color: #666; margin-bottom: 4px; }
.buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
button { padding: 12px 28px; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; font-weight: bold; transition: all 0.2s; }
button:hover { transform: scale(1.05); }
#btnPlay { background: #7b68ee; color: white; }
#btnStop { background: #444; color: white; }
#btnExport { background: #ff6ec7; color: white; }
#status { text-align: center; margin-top: 15px; color: #7b68ee; min-height: 1.5em; }
.viz { width: 100%; height: 80px; background: #0a0a1a; border-radius: 6px; margin-top: 10px; }
.presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; justify-content: center; }
.presets button { padding: 6px 14px; font-size: 0.8em; background: #1a1a3a; border: 1px solid #444; color: #aaa; border-radius: 20px; }
.presets button:hover { border-color: #ff6ec7; color: #ff6ec7; }
</style>
</head>
<body>

<h1>üéπ Synth Pad Generator</h1>
<p class="subtitle">NexusAI Stream Intro ‚Äî Keys/Pad</p>

<div class="presets">
  <button onclick="loadPreset('dreamwave')">Dreamwave</button>
  <button onclick="loadPreset('darkpad')">Dark Pad</button>
  <button onclick="loadPreset('retroarp')">Retro Arp</button>
  <button onclick="loadPreset('warm')">Warm Analog</button>
</div>

<div class="panel">
  <h2>üéõÔ∏è Synth Engine</h2>
  <div class="row">
    <div class="control">
      <label>Waveform 1</label>
      <select id="wave1"><option value="sawtooth">Sawtooth</option><option value="square">Square</option><option value="triangle">Triangle</option><option value="sine">Sine</option></select>
    </div>
    <div class="control">
      <label>Waveform 2</label>
      <select id="wave2"><option value="sawtooth" selected>Sawtooth</option><option value="square">Square</option><option value="triangle">Triangle</option><option value="sine">Sine</option></select>
    </div>
    <div class="control">
      <label>Detune (cents) <span class="val" id="detuneVal">12</span></label>
      <input type="range" id="detune" min="0" max="50" value="12">
    </div>
  </div>
  <div class="row">
    <div class="control">
      <label>Attack (s) <span class="val" id="attackVal">0.8</span></label>
      <input type="range" id="attack" min="0.01" max="3" step="0.01" value="0.8">
    </div>
    <div class="control">
      <label>Release (s) <span class="val" id="releaseVal">1.5</span></label>
      <input type="range" id="release" min="0.1" max="4" step="0.1" value="1.5">
    </div>
    <div class="control">
      <label>Filter Cutoff (Hz) <span class="val" id="filterVal">2000</span></label>
      <input type="range" id="filter" min="100" max="8000" step="10" value="2000">
    </div>
  </div>
  <div class="row">
    <div class="control">
      <label>Chorus Depth <span class="val" id="chorusVal">0.5</span></label>
      <input type="range" id="chorus" min="0" max="1" step="0.01" value="0.5">
    </div>
    <div class="control">
      <label>Reverb Mix <span class="val" id="reverbVal">0.4</span></label>
      <input type="range" id="reverb" min="0" max="1" step="0.01" value="0.4">
    </div>
    <div class="control">
      <label>BPM <span class="val" id="bpmVal">120</span></label>
      <input type="range" id="bpm" min="60" max="180" step="1" value="120">
    </div>
  </div>
</div>

<div class="panel">
  <h2>üéµ Chord Progression (4 bars)</h2>
  <div class="row">
    <div class="control">
      <label>Key</label>
      <select id="key">
        <option value="A">A</option><option value="Bb">Bb</option><option value="B">B</option>
        <option value="C">C</option><option value="Db">Db</option><option value="D">D</option>
        <option value="Eb">Eb</option><option value="E">E</option><option value="F">F</option>
        <option value="Gb">Gb</option><option value="G">G</option><option value="Ab">Ab</option>
      </select>
    </div>
    <div class="control">
      <label>Enable Arpeggio</label>
      <select id="arp"><option value="0">Off (Pad only)</option><option value="1" selected>On</option></select>
    </div>
    <div class="control">
      <label>Arp Speed</label>
      <select id="arpSpeed"><option value="8">8th notes</option><option value="16" selected>16th notes</option></select>
    </div>
  </div>
  <div class="chord-seq" id="chordSeq"></div>
</div>

<canvas class="viz" id="viz"></canvas>

<div class="buttons">
  <button id="btnPlay" onclick="startPlay()">‚ñ∂ Play</button>
  <button id="btnStop" onclick="stopPlay()">‚ñ† Stop</button>
  <button id="btnExport" onclick="exportWav()">üíæ Export WAV</button>
</div>
<div id="status"></div>

<script>
const NOTES = { C:261.63, Db:277.18, D:293.66, Eb:311.13, E:329.63, F:349.23, Gb:369.99, G:392.00, Ab:415.30, A:440.00, Bb:466.16, B:493.88 };
const CHORD_TYPES = {
  'm':  [0,3,7],    'M':  [0,4,7],    'm7': [0,3,7,10],  'M7': [0,4,7,11],
  '7':  [0,4,7,10], 'dim':[0,3,6],    'sus4':[0,5,7],     'sus2':[0,2,7]
};
const CHORD_NAMES = ['m','M','m7','M7','7','dim','sus4','sus2'];

let chords = ['m','M','M','M']; // Am F C G relative
let roots = [0, 8, 3, 10]; // semitones from A: A=0, F=8, C=3, G=10

const allNotes = ['A','Bb','B','C','Db','D','Eb','E','F','Gb','G','Ab'];

function buildChordUI() {
  const seq = document.getElementById('chordSeq');
  seq.innerHTML = '';
  for (let i = 0; i < 4; i++) {
    const slot = document.createElement('div');
    slot.className = 'chord-slot';
    slot.innerHTML = `
      <div class="label">Bar ${i+1}</div>
      <select id="root${i}">${allNotes.map((n,j) => `<option value="${j}" ${j===roots[i]?'selected':''}>${n}</option>`).join('')}</select>
      <select id="type${i}">${CHORD_NAMES.map(c => `<option value="${c}" ${c===chords[i]?'selected':''}>${c}</option>`).join('')}</select>
    `;
    seq.appendChild(slot);
  }
}
buildChordUI();

// Slider value displays
['detune','attack','release','filter','chorus','reverb','bpm'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('input', () => document.getElementById(id+'Val').textContent = el.value);
});

function getChordFreqs(barIdx) {
  const keyBase = NOTES[document.getElementById('key').value];
  const rootSemitones = parseInt(document.getElementById('root'+barIdx).value);
  const type = document.getElementById('type'+barIdx).value;
  const intervals = CHORD_TYPES[type];
  const rootFreq = keyBase * Math.pow(2, (rootSemitones - allNotes.indexOf(document.getElementById('key').value)) / 12);
  // Use octave 3 for pad (divide by 2)
  return intervals.map(i => (rootFreq / 2) * Math.pow(2, i/12));
}

let actx = null, playing = false, stopFlag = false;

function createReverb(ctx, mix) {
  const conv = ctx.createConvolver();
  const len = ctx.sampleRate * 2;
  const buf = ctx.createBuffer(2, len, ctx.sampleRate);
  for (let ch = 0; ch < 2; ch++) {
    const d = buf.getChannelData(ch);
    for (let i = 0; i < len; i++) {
      d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i/len, 2);
    }
  }
  conv.buffer = buf;
  const dry = ctx.createGain(); dry.gain.value = 1 - mix;
  const wet = ctx.createGain(); wet.gain.value = mix;
  const out = ctx.createGain();
  return { conv, dry, wet, out, connect(src, dest) {
    src.connect(dry).connect(out);
    src.connect(conv).connect(wet).connect(out);
    out.connect(dest);
  }};
}

function renderAudio(ctx, dest, duration) {
  const bpm = parseInt(document.getElementById('bpm').value);
  const barDur = (60 / bpm) * 4;
  const attack = parseFloat(document.getElementById('attack').value);
  const release = parseFloat(document.getElementById('release').value);
  const detune = parseInt(document.getElementById('detune').value);
  const filterFreq = parseInt(document.getElementById('filter').value);
  const chorusDepth = parseFloat(document.getElementById('chorus').value);
  const reverbMix = parseFloat(document.getElementById('reverb').value);
  const arpOn = document.getElementById('arp').value === '1';
  const arpDiv = parseInt(document.getElementById('arpSpeed').value);
  const w1 = document.getElementById('wave1').value;
  const w2 = document.getElementById('wave2').value;

  const master = ctx.createGain();
  master.gain.value = 0.3;

  const filt = ctx.createBiquadFilter();
  filt.type = 'lowpass';
  filt.frequency.value = filterFreq;
  filt.Q.value = 2;

  // Slow filter sweep
  filt.frequency.setValueAtTime(filterFreq * 0.3, ctx.currentTime);
  filt.frequency.linearRampToValueAtTime(filterFreq, ctx.currentTime + duration * 0.6);
  filt.frequency.linearRampToValueAtTime(filterFreq * 0.5, ctx.currentTime + duration);

  const rev = createReverb(ctx, reverbMix);
  rev.connect(filt, dest);
  filt.connect(master).connect(dest);

  const now = ctx.currentTime;
  const loops = Math.ceil(duration / (barDur * 4));

  for (let loop = 0; loop < loops; loop++) {
    for (let bar = 0; bar < 4; bar++) {
      const t = now + (loop * 4 + bar) * barDur;
      if (t - now >= duration) break;
      const freqs = getChordFreqs(bar);

      // Pad layer
      freqs.forEach(freq => {
        [w1, w2].forEach((w, wi) => {
          const osc = ctx.createOscillator();
          osc.type = w;
          osc.frequency.value = freq;
          if (wi === 1) osc.detune.value = detune;
          const g = ctx.createGain();
          g.gain.setValueAtTime(0, t);
          g.gain.linearRampToValueAtTime(0.12, t + Math.min(attack, barDur * 0.5));
          g.gain.setValueAtTime(0.12, t + barDur - release);
          g.gain.linearRampToValueAtTime(0, t + barDur);
          osc.connect(g).connect(filt);
          osc.start(t);
          osc.stop(t + barDur + 0.1);
        });
      });

      // Chorus LFO on pad
      if (chorusDepth > 0) {
        const lfo = ctx.createOscillator();
        lfo.frequency.value = 0.5;
        const lfoGain = ctx.createGain();
        lfoGain.gain.value = chorusDepth * 15;
        lfo.connect(lfoGain);
        lfo.start(t);
        lfo.stop(t + barDur + 0.1);
      }

      // Arp layer
      if (arpOn) {
        const noteDur = (60 / bpm) / (arpDiv / 4);
        const arpNotes = [...freqs.map(f=>f*2), ...freqs.map(f=>f*4).slice(0,2)];
        const numNotes = Math.floor(barDur / noteDur);
        for (let n = 0; n < numNotes; n++) {
          const nt = t + n * noteDur;
          if (nt - now >= duration) break;
          const freq = arpNotes[n % arpNotes.length];
          const osc = ctx.createOscillator();
          osc.type = 'triangle';
          osc.frequency.value = freq;
          const g = ctx.createGain();
          g.gain.setValueAtTime(0, nt);
          g.gain.linearRampToValueAtTime(0.06, nt + 0.01);
          g.gain.exponentialRampToValueAtTime(0.001, nt + noteDur * 0.9);
          osc.connect(g).connect(filt);
          osc.start(nt);
          osc.stop(nt + noteDur);
        }
      }
    }
  }
  return master;
}

// Visualizer
const canvas = document.getElementById('viz');
const vctx = canvas.getContext('2d');
let analyser = null, animId = null;

function drawViz() {
  if (!analyser) return;
  const w = canvas.width = canvas.offsetWidth;
  const h = canvas.height = canvas.offsetHeight;
  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);
  vctx.fillStyle = '#0a0a1a';
  vctx.fillRect(0,0,w,h);
  const barW = w / data.length * 2.5;
  for (let i = 0; i < data.length / 2.5; i++) {
    const v = data[i] / 255;
    const bh = v * h;
    const hue = 270 + v * 60;
    vctx.fillStyle = `hsl(${hue}, 80%, ${40 + v*40}%)`;
    vctx.fillRect(i * barW, h - bh, barW - 1, bh);
  }
  animId = requestAnimationFrame(drawViz);
}

function startPlay() {
  stopPlay();
  actx = new AudioContext();
  analyser = actx.createAnalyser();
  analyser.fftSize = 512;
  const master = renderAudio(actx, analyser, 16);
  analyser.connect(actx.destination);
  playing = true;
  document.getElementById('status').textContent = 'üéµ Playing...';
  drawViz();
  setTimeout(() => { if (playing) stopPlay(); }, 17000);
}

function stopPlay() {
  playing = false;
  if (actx) { actx.close(); actx = null; }
  if (animId) { cancelAnimationFrame(animId); animId = null; }
  document.getElementById('status').textContent = '';
}

async function exportWav() {
  document.getElementById('status').textContent = '‚è≥ Rendering WAV...';
  const bpm = parseInt(document.getElementById('bpm').value);
  const barDur = (60 / bpm) * 4;
  const duration = barDur * 4; // 4 bars
  const sr = 44100;
  const offCtx = new OfflineAudioContext(2, sr * (duration + 2), sr);
  renderAudio(offCtx, offCtx.destination, duration + 1);
  const buf = await offCtx.startRendering();

  // Encode WAV
  const numCh = buf.numberOfChannels;
  const samples = buf.length;
  const bitsPerSample = 16;
  const byteRate = sr * numCh * bitsPerSample / 8;
  const blockAlign = numCh * bitsPerSample / 8;
  const dataSize = samples * blockAlign;
  const buffer = new ArrayBuffer(44 + dataSize);
  const view = new DataView(buffer);

  function writeStr(off, str) { for(let i=0;i<str.length;i++) view.setUint8(off+i, str.charCodeAt(i)); }
  writeStr(0,'RIFF'); view.setUint32(4, 36+dataSize, true); writeStr(8,'WAVE');
  writeStr(12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true);
  view.setUint16(22,numCh,true); view.setUint32(24,sr,true); view.setUint32(28,byteRate,true);
  view.setUint16(32,blockAlign,true); view.setUint16(34,bitsPerSample,true);
  writeStr(36,'data'); view.setUint32(40,dataSize,true);

  const ch0 = buf.getChannelData(0);
  const ch1 = numCh > 1 ? buf.getChannelData(1) : ch0;
  let off = 44;
  for (let i = 0; i < samples; i++) {
    const l = Math.max(-1, Math.min(1, ch0[i]));
    const r = Math.max(-1, Math.min(1, ch1[i]));
    view.setInt16(off, l * 0x7FFF, true); off += 2;
    view.setInt16(off, r * 0x7FFF, true); off += 2;
  }

  const blob = new Blob([buffer], {type:'audio/wav'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'nexusai-synth-pad.wav'; a.click();
  document.getElementById('status').textContent = '‚úÖ Exported! Check your downloads.';
}

// Presets
const PRESETS = {
  dreamwave: { wave1:'sawtooth', wave2:'sawtooth', detune:12, attack:0.8, release:1.5, filter:2000, chorus:0.5, reverb:0.4, bpm:120, arp:'1', arpSpeed:'16', key:'A', roots:[0,8,3,10], chords:['m','M','M','M'] },
  darkpad: { wave1:'square', wave2:'sawtooth', detune:20, attack:1.5, release:2.5, filter:800, chorus:0.7, reverb:0.6, bpm:100, arp:'0', arpSpeed:'8', key:'D', roots:[5,0,3,8], chords:['m','m','m7','M'] },
  retroarp: { wave1:'square', wave2:'square', detune:8, attack:0.1, release:0.5, filter:4000, chorus:0.3, reverb:0.3, bpm:130, arp:'1', arpSpeed:'16', key:'C', roots:[3,0,10,8], chords:['M','m','M','M'] },
  warm: { wave1:'triangle', wave2:'sine', detune:6, attack:1.2, release:2.0, filter:1500, chorus:0.8, reverb:0.5, bpm:110, arp:'0', arpSpeed:'8', key:'F', roots:[8,3,10,5], chords:['M','M','M','m'] }
};

function loadPreset(name) {
  const p = PRESETS[name];
  document.getElementById('wave1').value = p.wave1;
  document.getElementById('wave2').value = p.wave2;
  ['detune','attack','release','filter','chorus','reverb','bpm'].forEach(k => {
    document.getElementById(k).value = p[k];
    document.getElementById(k+'Val').textContent = p[k];
  });
  document.getElementById('arp').value = p.arp;
  document.getElementById('arpSpeed').value = p.arpSpeed;
  document.getElementById('key').value = p.key;
  roots = [...p.roots]; chords = [...p.chords];
  buildChordUI();
}
</script>
</body>
</html>
